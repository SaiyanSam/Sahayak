{% extends "base.html" %}

{% block title %}Home - IITB Sahayak{% endblock %}

{% block content %}
<section class="hero">
    <div class="hero-content">
        <h2>Start a Fundraiser Today</h2>
        <p>Help others by raising funds for those in need.</p>
        <button class="hero-btn" onclick="location.href='{{ url_for('start_fundraiser') }}'">Get Started</button>
    </div>
</section>

<section class="fundraisers">
    <h2 class="section-title">Recent Fundraisers</h2>
    <div class="fundraiser-grid">
        {% for fundraiser in fundraisers %}
        <div class="fundraiser-card">
            {% if fundraiser.image_filename %}
            <img src="{{ url_for('static', filename='uploads/' + fundraiser.image_filename) }}" alt="{{ fundraiser.title }}">
            {% else %}
            <img src="{{ url_for('static', filename='images/default.png') }}" alt="Default Image">
            {% endif %}
            <h3>{{ fundraiser.title }}</h3>
            <p>{{ fundraiser.description }}</p>
            <button class="donate-btn" onclick="openRazorpay({{ fundraiser.id }}, '{{ fundraiser.title }}')">Donate Now</button>
        </div>
        {% endfor %}
    </div>
</section>

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
    // Debugging: Ensure Razorpay is loaded
    console.log("Razorpay script loaded.");

    function openRazorpay(fundraiserId, fundraiserTitle) {
        console.log("Opening Razorpay for fundraiser:", fundraiserId, fundraiserTitle);

        // Set default donation amount in paisa (e.g., â‚¹1000 = 1000 * 100 paisa)
        var defaultAmount = 1000 * 100;

        // Razorpay options
        var options = {
            "key": "{{ razorpay_key }}", // Razorpay API Key
            "amount": defaultAmount,
            "currency": "INR",
            "name": fundraiserTitle,
            "description": "Donation for " + fundraiserTitle,
            "handler": function (response) {
                console.log("Payment successful, response:", response);

                // Send payment details to the server
                fetch('/payment-success', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        "razorpay_payment_id": response.razorpay_payment_id,
                        "razorpay_order_id": response.razorpay_order_id,
                        "razorpay_signature": response.razorpay_signature,
                        "fundraiser_id": fundraiserId,
                        "amount": defaultAmount / 100 // Convert back to rupees
                    })
                })
                .then(res => res.json())
                .then(data => {
                    console.log("Server response:", data);
                    if (data.status === 'success') {
                        alert('Donation Successful!');
                        window.location.href = '/fundraisers';
                    } else {
                        alert('Donation Failed. Please try again.');
                    }
                })
                .catch(error => {
                    console.error("Error sending payment data to server:", error);
                    alert('An error occurred while processing the payment.');
                });
            },
            "theme": {
                "color": "#3399cc"
            }
        };

        console.log("Opening Razorpay modal with options:", options);
        var rzp1 = new Razorpay(options);
        rzp1.open();
    }
</script>
{% endblock %}
